# Agent A の批判的レビュー

> 耐障害性アーキテクトとして、Agent B（シンプリシティ）と Agent C（可観測性）の提案を批判的に評価する。自らの提案を堅持しつつ、三者の統合案を提示する。

---

## Agent B（シンプリシティ）への評価

### 同意する点

**1. Cron Guard CLI 化（提案 1）は最も費用対効果が高い改善である**

これは全面的に同意する。現在の Cron Guard ワンライナーが13箇所に散在し、各所で LLM が正確にコピーする必要がある現状は、耐障害性の観点から見ても最大のリスク表面である。Agent B の「セッションあたり約 49% の確率で少なくとも1回の Cron Guard 失敗」という定量的分析は説得力があり、私が問題点 1 で指摘した「Cron Guard のベストエフォート方式は黙って壊れる」問題の根本原因を正しく捉えている。

`mc cron-guard disable/enable` への一元化は、LLM の不確実性を排除し、テンプレートの認知負荷を下げ、かつ実装コストが低い（50行程度）。私の提案7（ファイルロック）よりも先にこれを実装すべきだ。

**2. cron メッセージの最小化（提案 6）は正しい**

Single Source of Truth を AGENTS.md に統一するのは、私が問題点 4 で指摘した「LLM の指示逸脱」リスクを軽減する。cron メッセージと AGENTS.md の齟齬が LLM の混乱を招くという分析は、私の見解と完全に一致する。

**3. テンプレート DRY 化（提案 5）の方向性は正しい**

共通セクションの外出しは保守性を向上させる。ただし、これは提案 1（CLI 化）を前提にすると自然に達成される部分が大きいため、独立した提案としての優先度は低い。

**4. Step 再番号付け（提案 4）は合理的**

`3 -> 3.5 -> 3.7 -> 3.8` は確かに LLM にとって認知負荷が高い。連続整数への変更は低コストで効果がある。

### 反論する点

**1. Supervisor 統合（提案 2）は耐障害性の観点で危険である**

これは Agent B の提案で最も議論が必要な点であり、**強く反対する**。

Agent B は「API コスト 67% 削減」「レイテンシ削減」を根拠に brain 単一統合を提案しているが、以下の致命的な問題を見落としている:

- **単一障害点の深刻化**: 現在の3エージェント分離は、確かに伝言ゲームのレイテンシを生むが、同時に **brain がクラッシュしても monitor が独立して動作し、stale agent recovery を実行できる** という耐障害性を提供している。brain に全機能を統合すると、brain のクラッシュ = 監視機能の喪失 + エスカレーション機能の喪失 + タスク管理機能の喪失となる。これは私が問題点 1 で指摘した「monitor の monitor が存在しない」問題をさらに悪化させる。

- **「brain が死んだら全て止まる」リスク**: 統合された brain の cron が Cron Guard 失敗で無効のまま放置された場合、タスク管理・監視・エスカレーションの全てが停止する。現在の設計では monitor が brain の cron を復旧する可能性があるが、統合後はその安全網がない。

- **セッション時間の増大は LLM の安定性を損なう**: Agent B 自身が「brain のセッション時間が長くなる」と認めている。LLM のセッションが長くなるほど、後半のステップの実行精度が低下するのは Agent B の問題 3（Phase 管理ロジックの複雑さ）で自ら指摘した論点と矛盾する。統合によりワークフローが長くなれば、各ステップの実行精度は下がる。

- **コスト最適化は安全性の後に来るべき**: API コスト 67% 削減は魅力的だが、OMOS は人間不在で自律的に動くシステムである。コスト削減のために監視の独立性を犠牲にするのは、本番運用で「サイレント障害の常態化」を招く。

**代替案**: 私の提案 4（brain-monitor 相互監視）の方が適切。3エージェント分離を維持しつつ、brain と monitor が互いの cron 状態を監視し合うことで、Agent B が指摘する「伝言ゲーム問題」を部分的に解決しつつ、耐障害性を強化できる。

**2. Phase 管理 CLI 化（提案 3）は正しい方向だが過小評価されている**

Agent B は提案 3 を「Low（将来的に検討）」としているが、これは誤りだと考える。brain が plan.md を heredoc で書き換えるリスクは、Agent B 自身が問題 8（plan.md の heredoc 書き換えで内容を破損）で「発生頻度: 中」と評価している。また、私の問題点 3（plan.md 書き込みの非原子性）と Agent C の問題点 3（plan.md の解釈保証の欠如）は、全エージェントが共通して指摘する最重要問題である。

Phase 管理を mc CLI に移す判断は正しいが、Supervisor 統合の後ではなく、**先に実施すべき**だ。brain の認知負荷を下げることが先決であり、Supervisor 統合は不要だからだ。

**3. 障害点分析（問題 5）は包括的だが、対策の優先順位が歪んでいる**

Agent B は15の障害点を列挙し、Cron Guard CLI 化と Supervisor 統合で「15 -> 8 に削減」と主張している。しかし、削減される7つの障害点の多くは「LLM 生成精度に依存する問題」（#6, #7, #8）であり、CLI 化では解決するが Supervisor 統合で解決するわけではない。Supervisor 統合が削減する障害点は #9, #10（メッセージ配送遅延）程度であり、これらは「遅延するが最終的に届く」性質のものだ。一方で Supervisor 統合が**新たに生み出す障害点**（brain 単一障害点の深刻化）をAgent Bは計上していない。

### 見逃している点

**1. Worker の in_progress タスク放棄問題への言及がない**

Agent B は Supervisor 側の問題に集中しており、私が問題点 8 で指摘した「in_progress タスクの再開メカニズムがない」問題に全く触れていない。Worker がクラッシュした場合のタスク放棄は、Supervisor 統合では解決しない。これは base.md の修正（3行追加）で解決できる最もコスト効率の高い改善であり、見落としは重大だ。

**2. setup_mission の冪等性問題への言及がない**

Agent B は「setup_mission の部分失敗」を障害点 #14 として列挙しているが、具体的な対策を提案していない。私の提案 3（setup_mission の冪等化）は Python コードの修正であり、LLM の不確実性に影響されないため、最も確実に実装できる改善の一つだ。

**3. エスカレーションの到達保証問題が軽視されている**

Supervisor を brain に統合すると、brain のセッション出力が cron --announce で Slack に届くことでエスカレーション機能を代替すると Agent B は主張している。しかし、brain のセッションが正常完了しない場合（クラッシュ、タイムアウト等）、--announce は発火しない。つまり **クリティカルなエスカレーション（セキュリティインシデント等）が永久に配信されないリスク** が Supervisor 統合によって増大する。

---

## Agent C（可観測性）への評価

### 同意する点

**1. 実行トレーサビリティの欠如（問題 1）の指摘は的確**

brain の判断根拠がセッションログに埋もれ、構造化されていないという指摘は正しい。特に「なぜ brain はこのタスクを作ったのか」が追跡できない点は、障害発生時の根本原因分析を不可能にする。私の提案 5（LLM ガードレール）の監査ログ（audit.jsonl）は同じ方向性であり、Agent C の Decision Log（decision-log.jsonl）と補完関係にある。

**2. Plan Drift 検知（提案 4）は monitor の機能拡張として自然で有用**

monitor に plan と実際のタスクの乖離を検知させるのは、私が問題点 4 で指摘した「brain の過剰行動」への対策として有効だ。brain が plan にないタスクを大量生成した場合や、priority が計画と乖離した場合に検知できる仕組みは、ガードレールとして価値が高い。

**3. 人間の介入チャネルの不足（問題 2）の指摘は重要**

`mc mission instruct` が次の cron サイクル（最大6時間後）まで読まれないという問題は、私が問題点 7 で指摘した「エスカレーションの到達保証」の逆方向（人間 -> AI）の問題だ。提案 5c（brain の指示解釈確認ログ）は、指示が正しく解釈されたことの検証手段として有用。

**4. タスク作成検証（提案 6）は低コストで高い安全性を得られる**

brain が作成したタスクを自己検証するステップの追加は、追加コスト（mc list の1回実行 + 比較ロジック）に対して安全性向上が大きい。特に Phase 1（Auto: true）の初回タスク作成時のミスは、ミッション全体の方向性を歪めるため、早期検出が重要。

### 反論する点

**1. YAML フロントマター（提案 2）は追加複雑性に見合う価値がない**

これは Agent C の提案で最も議論が必要な点であり、**強い懸念がある**。

- **二重管理のリスクが深刻**: Agent C 自身が「フロントマターと Markdown 本文の二重管理。不整合が発生する可能性」とトレードオフに明記している。YAML フロントマターと Markdown 本文の二つの「真実の源」が存在する設計は、私が問題点 3 で指摘した plan.md の破損リスクをむしろ悪化させる。brain が Markdown 本文だけ更新して YAML を更新し忘れる、あるいはその逆が起きた場合、どちらが正しいか判断できない。

- **architect の認知負荷が増大する**: plan.md を作成するのは mc-architect（LLM エージェント）である。mc-architect が YAML フロントマターの正確な構文（インデント、キー名、値のクォーティング等）を毎回正確に生成する保証がない。Agent B が Cron Guard ワンライナーの生成ミスを問題視したのと同じ論理で、YAML 生成もミスリスクがある。

- **「LLM に構造化データを正確に生成させる」前提の矛盾**: 三者とも「LLM は複雑な操作を正確に実行できない」ことを問題の核心として捉えているのに、Agent C は「LLM に YAML フロントマターを正確に書かせる」ことを解決策として提案している。これは矛盾だ。

- **Agent B の提案 3（Phase 管理 CLI 化）の方が本質的**: plan.md の解釈精度を上げたいなら、plan.md 自体を構造化するのではなく、plan.md の解釈を mc CLI に委任すべきだ。mc CLI が plan.md をパースし、`mc phase create-tasks` のような宣言的コマンドを提供すれば、brain は plan.md の構造を理解する必要がなくなる。

**代替案**: 私は YAML フロントマターの代わりに、以下を推奨する:
1. plan.md は現在の Markdown フォーマットを維持（人間の可読性を優先）
2. `setup_mission` が plan.md をパースし、構造化されたタスク定義を `{config_dir}/projects/{project}/plan-tasks.json` として出力
3. brain はこの JSON を参照してタスクを作成

これにより、構造化データの生成は Python コード（setup_mission）が行い、LLM の YAML 生成リスクを排除できる。

**2. Phase 状態マシン（提案 3）は plan.md との二重管理を増やすだけ**

Agent C 自身が「phase-state.json と plan.md の二重管理リスクが高い」と Low 優先度に分類している。この自己評価は正しい。Phase 状態を別ファイルで管理すると、brain が plan.md の emoji（🔄, ✅）と phase-state.json の `status` を両方更新する必要があり、不整合のリスクが高まる。

Agent B の提案 3（mc CLI に Phase 管理を移す）の方が、この問題をより根本的に解決する。mc CLI が単一の真実の源として Phase 状態を管理し、plan.md の更新も CLI が行えば、二重管理は発生しない。

**3. Decision Log（提案 1）の実装方法にリスクがある**

Decision Log の概念自体は価値があるが、Agent C の実装案は `echo` で JSON を直接生成するものだ:

```bash
echo '{"ts":"'"$(date -u '+%Y-%m-%dT%H:%M:%SZ')"'","agent":"{agent_id}","type":"<action_type>","detail":"<brief_description>"}' >> "{config_dir}/projects/{project}/decision-log.jsonl"
```

これは Agent B が批判した Cron Guard ワンライナーと同じ問題を抱えている。LLM がシェルのクォーティング（シングルクォートとダブルクォートの入れ子）を正確に生成する保証がない。特に `<brief_description>` にシェル特殊文字（`$`, `"`, バッククォート等）が含まれると JSON が壊れる。

**改善案**: Decision Log も mc CLI のコマンドにすべきだ:
```bash
mc -p {project} -m {mission} log-decision --type task_create --detail "Created #12 for backend"
```

### 見逃している点

**1. monitor 自身の障害シナリオへの対策がない**

Agent C は monitor の機能拡張（Plan Drift 検知等）を提案しているが、monitor 自身がクラッシュした場合の対策が欠如している。これは私が問題点 1, 6 で指摘した「monitor の monitor が存在しない」問題であり、Agent C の全提案の前提を揺るがす。monitor の機能をいくら拡充しても、monitor が動かなければ意味がない。

**2. in_progress タスクの再開メカニズムへの言及がない**

Agent B と同様、Agent C も Worker のクラッシュリカバリ（in_progress タスクの再開）に言及していない。可観測性の向上は「問題を見える化する」ものだが、「問題を自動修復する」メカニズムは別途必要であり、私の提案 1（in_progress 再開ロジック）がそれを担う。

**3. セッション時間とトークン消費への配慮が不足**

Agent C の提案は全体的に「各セッションにステップを追加する」方向であり、テンプレートの肥大化を招く。Decision Log、Phase 状態ファイル更新、Plan Drift 検知、タスク作成検証、指示解釈確認ログ——これらを全て実装すると、brain のセッションに追加される bash コマンドは 10-15 回に及ぶ。Agent B が問題 6 で指摘した「テンプレートの肥大化とコンテキスト消費」を悪化させる方向であり、LLM の実行精度を下げるリスクがある。

---

## 三者統合への提案

3つの視点を統合した場合の最適な設計方針を、優先度順に提案する。

### Tier 1: 即座に実施（工数小・効果大・リスク低）

| # | 施策 | 出典 | 理由 |
|---|------|------|------|
| 1 | **Cron Guard の mc CLI コマンド化** | Agent B 提案 1 | 全員が指摘する最大のリスク表面を排除。LLM の不確実性から切り離す。実装 50 行。 |
| 2 | **in_progress タスクの優先再開ロジック** | Agent A 提案 1 | base.md に 3 行追加。Worker のクラッシュリカバリとして最もコスト効率が高い。Agent B, C ともに見落としている。 |
| 3 | **cron メッセージの最小化** | Agent B 提案 6 | setup_mission.py の 1 関数修正。Single Source of Truth の確立。 |
| 4 | **setup_mission の冪等化** | Agent A 提案 3 | Python コードの修正なので確実に動作。部分障害からの安全なリトライを保証。 |

### Tier 2: 次のイテレーション（工数中・効果大）

| # | 施策 | 出典 | 理由 |
|---|------|------|------|
| 5 | **Phase 管理の mc CLI 移管** | Agent B 提案 3 | plan.md の直接テキスト操作を排除。brain の認知負荷を大幅削減。Agent C のフロントマター提案よりも本質的な解決。 |
| 6 | **brain-monitor 相互監視** | Agent A 提案 4 | 単一障害点を解消しつつ、3エージェント分離を維持。Agent B の Supervisor 統合よりも安全。 |
| 7 | **brain の Guardrails セクション追加** | Agent A 提案 5 | タスク作成上限、Phase 規律、エスカレーション閾値。テンプレートへの追記のみで低コスト。 |
| 8 | **タスク作成検証** | Agent C 提案 6 | brain が作成したタスクの自己検証。Phase 管理 CLI と組み合わせると精度が高い。 |

### Tier 3: 中期（工数大・効果中〜大）

| # | 施策 | 出典 | 理由 |
|---|------|------|------|
| 9 | **Decision Log の mc CLI コマンド化** | Agent C 提案 1 + Agent A 提案 5 | Agent C の概念 + echo ではなく `mc log-decision` コマンドとして実装。LLM の JSON 生成リスクを排除。 |
| 10 | **Plan Drift 検知** | Agent C 提案 4 | Phase 管理 CLI（施策 5）導入後に、構造化データに基づく正確な drift 検知が可能に。 |
| 11 | **plan.md 安全書き込み** | Agent A 提案 2 | Phase 管理 CLI（施策 5）導入前の暫定措置として、バックアップ + tmp 書き込み + バリデーション。 |
| 12 | **mc-architect Step 再番号付け** | Agent B 提案 4 | 仕様書と AGENTS.md の両方を更新する必要があるが、工数は小さい。 |

### Tier 4: 長期（投資対効果を見極めて判断）

| # | 施策 | 出典 | 判断基準 |
|---|------|------|---------|
| 13 | Dashboard コマンド | Agent C 提案 5b | 既存コマンドの組み合わせで代替可能。ユーザーの要望次第。 |
| 14 | YAML フロントマター | Agent C 提案 2 | Phase 管理 CLI + plan-tasks.json で代替可能。二重管理リスクが解消されない限り不採用。 |
| 15 | Supervisor 統合 | Agent B 提案 2 | 相互監視（施策 6）で十分な耐障害性が確保された後、コスト最適化の観点で再評価。ただし、monitor の独立性を犠牲にするリスクは残る。 |

### 統合設計の原則

三者の提案を統合する際の設計原則:

1. **「複雑なロジックは mc CLI に、LLM には単純な判断とコマンド呼び出しのみ」**（Agent B の結論に同意）
2. **「検証は外部（mc CLI / ファイルシステム）で行い、LLM の出力を信頼しない」**（Agent A の設計哲学）
3. **「可観測性は重要だが、テンプレートの肥大化は LLM の実行精度を下げる」**（Agent B の問題 6 + Agent A のパラドックス）
4. **「耐障害性のために関心の分離（3エージェント分離）は維持する」**（Agent A の立場）
5. **「構造化データの生成は Python コードに任せ、LLM に YAML/JSON を書かせない」**（全員の問題意識の統合）

---

## 絶対に譲れない点

耐障害性の観点から、どんな設計でも必ず含めるべき要件を列挙する。

### 1. monitor と brain の独立性を維持すること

Agent B の Supervisor 統合案は、コスト最適化として魅力的だが、**監視機能の独立性は OMOS の最後の防衛線** である。brain がクラッシュしても monitor が独立して stale agent recovery を実行でき、逆も同様であるという相互監視体制は、自律エージェントシステムの最低限の安全網だ。

**妥協案**: brain と monitor のスケジュールをずらす（例: brain は 0,6,12,18 時、monitor は 3,9,15,21 時）ことで、片方がクラッシュしても最大3時間以内にもう片方が起動し、復旧を試みる。これにより、Agent B が懸念する「最大12時間のレイテンシ」を6時間に短縮できる。

### 2. in_progress タスクの再開メカニズムが存在すること

Worker がクラッシュした場合に in_progress タスクが永久に放棄される現在の設計は、最も基本的な耐障害性の欠如だ。base.md の Step 3 に「in_progress の自タスクを先に確認する」ロジックを追加するだけで解決でき、工数は最小。これを含めない設計は受け入れられない。

### 3. setup_mission がリトライ安全（冪等）であること

ミッションの起動（setup_mission）は OMOS のライフサイクルの起点であり、ここが壊れるとミッション全体が起動しない。register_agent の各サブステップに存在確認を入れ、部分障害からの安全なリトライを保証すべき。これは Python コードの修正であり、LLM の不確実性に影響されない確実な改善。

### 4. Cron Guard の信頼性が CLI レベルで担保されていること

13箇所に散在する bash ワンライナーを LLM が毎回正確に生成することに依存する現在の設計は、システムの信頼性の基盤として不適切。`mc cron-guard` コマンドへの一元化は、三者全員が認める最優先改善事項。

### 5. plan.md の書き込みに何らかの安全機構があること

brain が plan.md を heredoc で直接上書きする現在の設計は、3エージェント全員が問題として指摘している。最低限、バックアップの作成と書き込み後のバリデーション（非空・Goal セクションの存在確認）は必須。理想的には Phase 管理 CLI に移行して brain の直接書き込みを排除すべき。

### 6. クリティカルなエスカレーションが最終的に人間に届くこと

OMOS が自律的に動作する以上、「壊れたら人間に通知する」仕組みは全自動復旧よりも重要。セキュリティインシデント、予算超過、データ損失の可能性がある場合に、escalator（または brain の --announce）が正常に動作しなくても、**何らかの経路で人間に通知が届く設計** を保証すべき。具体的には、brain と escalator の両方が独立して Slack 通知を試みる冗長構成が望ましい。
